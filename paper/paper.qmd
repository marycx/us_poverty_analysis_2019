---
title: "Understanding the Impact of Marital Status, Income, and Age on Individuals' Poverty Status"
subtitle: "An Analysis of the 2019 Revised Supplemental Poverty Measure Dataset"
author: 
  - Mary Cheng
thanks: "Code and data are available at: https://github.com/marycx/us_poverty_analysis_2019.git"
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(arrow)
library(here)
library(rstanarm)
library(modelsummary)
library(ggplot2)
library(knitr)
library(marginaleffects)
library(plotly)
library(tibble)
library(margins)
library(kableExtra)
```


# Introduction

You can and should cross-reference sections and sub-sections. We use @citeR and @rohan.

The remainder of this paper is structured as follows. @sec-data....



# Data {#sec-data}

## Data Source

## Features

```{r}
#| include: false
#| warning: false
#| message: false

# read in raw data
raw_poverty_data <-  read_csv(here::here("data/raw_data/raw_poverty_data.csv"))
```

```{r}
#| label: tbl-raw
#| tbl-cap: "Preview of the raw 2019 US Supplemental Poverty Measure dataset"
#| message: false
#| echo: false

raw_poverty_data[1:5, 1:4] |>
  kable()
```


## Data Measurement

## Methodology

```{r}
#| include: false
#| warning: false
#| message: false

# read in cleaned data
poverty2019 <-  read_parquet(here::here("data/analysis_data/cleaned_poverty_data.parquet"))

poverty2019 <-
  poverty2019 |>
  mutate(
    poverty_status = as_factor(poverty_status),
    mortgage_state= factor(
      mortgage_state,
      levels = c(
      "Owner with Mortgage",
      "Owner without Mortgage or rent-free",
      "Renter")
    ),
    income = factor(
      income,
      levels = c(
      "below 10k",
      "10k-50k",
      "50k-100k",
      "100k-150k",
      "150k-200k",
      "200k-250k",
      "above 250k")
    )
  ) |>
  select(poverty_status, mortgage_state, income)
```

```{r}
#| label: tbl-clean-data
#| tbl-cap: "Preview of the cleaned 2019 US Supplemental Poverty Measure dataset"
#| message: false
#| echo: false

poverty2019[5:9, 1:4] |>
  kable()
```

```{r}
#| label: tbl-summary
#| tbl-cap: "Statistics summary of the cleaned 2019 US Supplemental Poverty Measure dataset"
#| message: false
#| echo: false

poverty2019 |>
  summary() |>
  kable(align = "c") %>%
  kable_styling(font_size = 8)
```


## Data Visualization
```{r}
#| label: fig-mortgage
#| fig-cap: The distribution of poverty status by mortgage state
#| echo: false
#| warning: false
#| message: false
poverty2019 |>
  ggplot(aes(x = mortgage_state, fill = poverty_status)) +
  geom_bar(position = "dodge") +
  coord_flip() +
  theme_minimal() +
  theme(axis.text.x=element_text(hjust=1, vjust=0.5),
        text=element_text(size=6)) +
  scale_fill_brewer(palette = "Set1") +
  labs(
    x = "Mortgage state",
    y = "Number of respondents",
    fill = "Poverty status"
  )
```
```{r}
#| label: fig-income
#| fig-cap: The distribution of poverty status by income level
#| echo: false
#| warning: false
#| message: false
poverty2019 |>
  ggplot(aes(x = income, fill = poverty_status)) +
  geom_bar(position = "dodge") +
  coord_flip() +
  theme_minimal() +
  scale_fill_brewer(palette = "Set1") +
  labs(
    x = "Income level",
    y = "Number of respondents",
    fill = "Poverty status"
  )
```


# Model

The goal of our modelling strategy is twofold. Firstly,...

Here we briefly describe the Bayesian analysis model used to investigate... Background details and diagnostics are included in [Appendix -@sec-model-details].

## Model set-up

Define $y_i$ as the number of seconds that the plane remained aloft. Then $\beta_i$ is the wing width and $\gamma_i$ is the wing length, both measured in millimeters.  

\begin{align} 
y_i|\pi_i &\sim \mbox{Bern}(\pi_i) \\
\mbox{logit}(\pi_i) &= \alpha + \beta_1 \times \mbox{mortgage}_i + \beta_2 \times \mbox{income}_i + \beta_3 \times \mbox{age}_i\\
\alpha &\sim \mbox{Normal}(0, 2.5) \\
\beta_1 &\sim \mbox{Normal}(0, 2.5) \\
\beta_2 &\sim \mbox{Normal}(0, 2.5)
\end{align}

We run the model in R [@citeR] using the `rstanarm` package of @rstanarm. We use the default priors from `rstanarm`.


### Model justification

We expect a positive relationship between the size of the wings and time spent aloft. In particular...

We can use maths by including latex between dollar signs, for instance $\theta$.


# Results

Our results are summarized in @tbl-modelresults.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: tbl-modelresults
#| tbl-cap: "Explanatory model Poverty Prediction (n = 1000)"

poverty_prediction_model <-
  readRDS(file = here::here("models/poverty_prediction_model.rds"))

modelsummary(
  list(
    "In poverty" = poverty_prediction_model
  ),
  statistic = "mad"
  )
```




# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}

# Model details {#sec-model-details}

## Posterior predictive check
In @fig-post_dist, we implement a posterior distribution. This compares the poverty status of people in reality with the prediction results from the posterior distribution from our logistic regression model. It can be seen that the posterior distribution fits well with the actual data. It suggests that the posterior is able to generate simulated data that closely resembles the actual data [@bayes_post], because the model accurately captures the observed data patterns. This is good because it indicates that our logistic regression model is a good representation of the actual poverty status in the 2019 poverty data from United States Census Bureau.

```{r}
#| label: fig-post_dist
#| fig-cap: Posterior distribution for logistic regression model 
#| echo: false
#| warning: false
#| message: false
#| 

pp_check(poverty_prediction_model) +
  theme(legend.position = "bottom")
```

@fig-post_prior compares the posterior with the prior. This compares the prior distribution of parameters with the posterior distribution of parameters in our logistic regression model. We can see that half of the model parameters do not change after data are taken into account, while some parameters shift slightly. This shows that the observed data partially matches with our initial belief and expectation about the poverty status of people in the United States in 2019. We can see that for people with income level at "below 10k" and "10k-50k", the posterior distributions shift from their prior after we input observed data; their distribution not crossing 0 at all. This is suggesting that the observed data for "below 10k" and "10k-50k" strongly contradict our initial belief. So the majority of people in US who earns less than a total amount of 50k per household annually was in poverty in 2019. Also, the intercept (people who are owners with mortgage and earn 100-150k) shifts to the left; its distribution not crossing 0. This indicates that the actual observation does not match with our prior belief. People in this category was less likely to be in poverty state in 2019 United States.

```{r}
#| label: fig-post_prior
#| fig-cap: Comparing the posterior with the prior 
#| echo: false
#| warning: false
#| message: false

#### Read data ####
analysis_data <- read_parquet(here::here("data/analysis_data/cleaned_poverty_data.parquet"))

# Convert variables to factors
analysis_data$marital_status <- factor(analysis_data$mortgage_state)
analysis_data$income <- factor(analysis_data$income)

# Create poverty_status variable in binary form
analysis_data$poverty_status <- ifelse(analysis_data$poverty_status == "In poverty", 1, 0)

# Model 1 for n = 1000
set.seed(215)

poverty_data_reduced <- 
  analysis_data |> 
  slice_sample(n = 1000)

posterior_vs_prior(poverty_prediction_model, size = 0.1) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  theme(axis.text.x=element_text(hjust=1, vjust=0.5),
        text=element_text(size=8)) +
  guides(color = guide_legend(ncol = 4))+
  coord_flip()
```

## Markov chain Monte Carlo Convergence Check

@fig-trace1, @fig-trace2, @fig-trace3 are the trace plots of the model. It tells us if there is existence of signs that the our model runs into issues. We observe lines in all the trace plots are horizontal and oscillating, and have overlaps between the chains. This suggests that there is nothing strange in this trace plot.

@fig-rhat is the Rhat plot of the model. It compares the variability within each chain to the variability between chains in MCMC. We can observe that our Rhat plot are all close to 1, and no more than 1.05. This is a good sign because it suggests that the MCMC algorithm has reached convergence for our model. 


```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-trace1
#| fig-cap: "Trace plot of intercept and marital status"
#| fig-subcap: ["Trace plot of Intercept", "Trace plot of Owner without Mortgage or rent-free", "Trace plot of Renter"]
#| layout-ncol: 2

plot(poverty_prediction_model, "trace", "(Intercept)")
plot(poverty_prediction_model, "trace", "mortgage_stateOwner without Mortgage or rent-free")
plot(poverty_prediction_model, "trace", "mortgage_stateRenter")
```

```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-trace2
#| fig-cap: "Trace plot of income"
#| fig-subcap: ["Trace plot of income 10k-50k", "Trace plot of income 150k-200k", "Trace plot of income 200k-250k", "Trace plot of income 50k-100k", "Trace plot of income above 250k", "Trace plot of income below 10k"]
#| layout-ncol: 2

plot(poverty_prediction_model, "trace", "income10k-50k")
plot(poverty_prediction_model, "trace", "income150k-200k")
plot(poverty_prediction_model, "trace", "income200k-250k")
plot(poverty_prediction_model, "trace", "income50k-100k")
plot(poverty_prediction_model, "trace", "incomeabove 250k")
plot(poverty_prediction_model, "trace", "incomebelow 10k")
```



```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-rhat
#| fig-cap: "Rhat plot"

plot(poverty_prediction_model, "rhat")
```
```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-modelresults1
#| fig-cap: "Credible intervals for predictors of positive poverty status"

modelplot(poverty_prediction_model, conf_level = 0.90, size = 0.2) +
  labs(x = "90% credibility interval")
```


```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-modelresults2
#| fig-cap: "Credible intervals for predictors of positive poverty status with x_axis limits"

# Create the model plot
model_plot <- modelplot(poverty_prediction_model, conf_level = 0.90, size = 0.2)

# Modify the x-axis limits
model_plot + xlim(-5, 5) +  # Adjust the limits as needed
  labs(x = "90% Credibility Interval")
```


\newpage


# References


